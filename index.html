<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cubo Logico">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">

    <title>Cubo Logico</title>

    <link rel="apple-touch-icon" href="icona.png">
    <link rel="icon" type="image/png" href="icona.png">

    <style>
        /* CSS: Layout e Stile */
        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background-color: #2c3e50;
            color: white;
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            display: flex; justify-content: center; align-items: center; 
            overflow: hidden; user-select: none;
            -webkit-tap-highlight-color: transparent;
            /* Padding per evitare che l'interfaccia finisca sotto la tacca degli iPhone nuovi */
            padding-top: env(safe-area-inset-top);
        }

        #scaler-container {
            transform-origin: center center;
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            width: 540px; 
            display: flex; justify-content: center; align-items: center;
            position: relative;
        }

        /* --- MENU INIZIALE --- */
        #start-menu {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: #34495e; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); border: 2px solid #4e6a85;
            padding: 40px; width: 100%; max-width: 400px; z-index: 100;
        }
        
        .game-logo {
            font-size: 40px; font-weight: 900; margin-bottom: 30px;
            text-transform: uppercase; letter-spacing: 2px;
            text-shadow: 0 5px 0 #2c3e50; text-align: center;
        }
        
        .menu-btn {
            background: #e67e22; color: white;
            font-size: 22px; font-weight: bold;
            padding: 15px 40px; width: 100%;
            border: none; border-radius: 50px;
            margin-bottom: 15px; cursor: pointer;
            box-shadow: 0 5px 0 #d35400; transition: transform 0.1s;
        }
        .menu-btn:active { transform: translateY(5px); box-shadow: none; }
        .menu-btn.secondary { background: #1abc9c; box-shadow: 0 5px 0 #16a085; }
        .menu-btn.info { background: #3498db; box-shadow: 0 5px 0 #2980b9; }

        /* --- CONTENITORE GIOCO --- */
        #main-container {
            display: none;
            gap: 15px; padding: 15px;
            background-color: #34495e; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); border: 2px solid #4e6a85;
            flex-direction: column; align-items: center;
            width: 500px; 
        }

        @media (min-width: 850px) {
            #scaler-container { width: 850px; }
            #main-container {
                flex-direction: row; align-items: flex-start;
                padding: 20px; gap: 20px; width: auto;
            }
        }

        #sidebar {
            display: flex; flex-direction: row; flex-wrap: wrap;
            justify-content: center; width: 100%; gap: 8px;
        }
        
        @media (min-width: 850px) {
            #sidebar {
                flex-direction: column; width: 240px; flex-wrap: nowrap; gap: 12px;
            }
        }

        .panel-title {
            width: 100%; text-align: center; font-size: 24px; font-weight: 800;
            color: #ecf0f1; margin-bottom: 2px; text-transform: uppercase;
            letter-spacing: 1px; border-bottom: 4px solid #1abc9c; padding-bottom: 5px;
        }

        .stat-box {
            background: #2c3e50; padding: 5px 8px;
            border-radius: 8px; border-left: 4px solid #1abc9c;
            min-width: 70px; text-align: center; flex-grow: 1;
        }

        .stat-label { font-size: 9px; color: #bdc3c7; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;}
        .stat-value { font-size: 18px; font-weight: bold; color: #f1c40f; line-height: 1.1;}

        #timer-box { border-left-color: #e67e22; }
        #timer-display { font-family: 'Courier New', monospace; font-size: 22px; }

        #mission-box { 
            border-left-color: #9b59b6; display: flex; flex-direction: row; 
            align-items: center; justify-content: center; gap: 8px; 
            min-width: 110px; padding: 5px 10px;
        }
        
        .mission-icon { width: 22px; height: 22px; border-radius: 4px; border: 2px solid white; flex-shrink: 0; }
        .mission-target { font-size: 16px; font-weight: 900; line-height: 1; }
        .mission-success { border-left-color: #2ecc71; background-color: #273c2e; }

        .controls { display: flex; gap: 8px; width: 100%; justify-content: center; margin-top: 5px; }

        button {
            padding: 10px; font-size: 14px; background-color: #576574;
            color: white; border: none; border-radius: 8px; cursor: pointer;
            font-weight: bold; flex: 1;
        }

        #game-area {
            position: relative; width: 500px; height: 500px; 
            background-color: #222; border-radius: 12px;
            border: 4px solid #2c3e50; box-shadow: inset 0 0 30px rgba(0,0,0,0.8);
            touch-action: none; cursor: pointer;
        }

        .cube {
            width: 46px; height: 46px; border-radius: 8px;
            position: absolute; display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 20px; color: rgba(255,255,255,0.9);
            box-sizing: border-box;
            transition: top 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), 
                        left 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                        transform 0.1s, opacity 0.2s;
            pointer-events: none; 
        }
        
        .color-1 { background: #ff6b6b; box-shadow: inset 0 -4px 0 rgba(0,0,0,0.2); }
        .color-2 { background: #48dbfb; box-shadow: inset 0 -4px 0 rgba(0,0,0,0.2); }
        .color-3 { background: #feca57; box-shadow: inset 0 -4px 0 rgba(0,0,0,0.2); }
        .color-4 { background: #1dd1a1; box-shadow: inset 0 -4px 0 rgba(0,0,0,0.2); }
        .color-5 { background: #5f27cd; box-shadow: inset 0 -4px 0 rgba(0,0,0,0.2); }

        .tnt { background: #2d3436; color: #ff9f43; border: 2px dashed #ff9f43; z-index: 50; }
        .tnt::after { content: "TNT"; font-weight: 900; font-size: 14px; }

        .preview { filter: brightness(1.4); transform: scale(0.92); border: 3px solid white; z-index: 100;}
        .tnt-range { filter: sepia(1) hue-rotate(-50deg) saturate(3); transform: scale(0.9); }
        .imploding { transform: scale(0); opacity: 0; }

        /* MODALI */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #modal-overlay.visible { opacity: 1; pointer-events: all; }
        .modal-box {
            background: #ecf0f1; color: #2c3e50; padding: 20px; width: 320px;
            border-radius: 15px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .modal-title { font-size: 22px; font-weight: 900; margin-bottom: 10px; }
        .modal-btn { background: #e67e22; font-size: 16px; padding: 12px; width: 100%; border-radius: 8px; color: white; border: none; font-weight: bold; cursor: pointer;}

        /* POPUP LIVELLO */
        #level-popup {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5);
            background: rgba(44, 62, 80, 0.95); padding: 20px;
            border-radius: 20px; border: 4px solid #9b59b6; text-align: center;
            z-index: 1500; opacity: 0; pointer-events: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; align-items: center; gap: 10px; width: 200px;
        }
        #level-popup.active { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .popup-icon { width: 50px; height: 50px; border-radius: 8px; border: 3px solid white; }
        .popup-target { color: #f1c40f; font-size: 36px; font-weight: 900; }

    </style>
</head>
<body>

    <div id="modal-overlay">
        <div class="modal-box" id="modal-content"></div>
    </div>

    <div id="level-popup">
        <div class="popup-title">Obiettivo</div>
        <div id="popup-icon" class="popup-icon"></div>
        <div id="popup-target" class="popup-target">0</div>
    </div>

    <div id="scaler-container">
        <div id="start-menu">
            <div class="game-logo">Cubo<br><span style="color:#1abc9c">Logico</span></div>
            <button class="menu-btn" onclick="startGame()">GIOCA</button>
            <button class="menu-btn secondary" onclick="showStats()">STATISTICHE</button>
            <button class="menu-btn info" onclick="showInstructions(true)">REGOLE</button>
        </div>

        <div id="main-container">
            <div id="sidebar">
                <div class="panel-title">Cubo <span style="color:#1abc9c">Logico</span></div>
                <div class="stat-box" id="timer-box">
                    <div class="stat-label">TEMPO</div>
                    <div class="stat-value" id="timer-display">90</div>
                </div>
                <div class="stat-box" id="mission-box">
                    <div class="stat-label">OBIETTIVO</div>
                    <div style="display:flex; align-items:center; gap:5px; justify-content:center;">
                        <div id="mission-icon" class="mission-icon"></div>
                        <div id="mission-target" class="mission-target">--</div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">LIVELLO</div>
                    <div class="stat-value" id="level-display">1</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">PUNTI</div>
                    <div class="stat-value" id="score-display">0</div>
                </div>
                <div class="controls">
                    <button id="music-btn" onclick="toggleMusic()">üéµ</button>
                    <button onclick="goToMenu()">üè†</button>
                    <button onclick="confirmRestart()">üîÑ</button>
                </div>
            </div>
            <div id="game-area"></div>
        </div>
    </div>

    <script>
        // Logica di gioco identica alla precedente (versione corretta)
        let gameStats = { highScore: 0, maxLevel: 1, totalGames: 0 };
        function loadStats() {
            const saved = localStorage.getItem('cuboLogicoStats');
            if (saved) gameStats = JSON.parse(saved);
        }
        function saveStats() { localStorage.setItem('cuboLogicoStats', JSON.stringify(gameStats)); }
        
        function showStats() {
            loadStats();
            const html = `
                <div class="modal-title">STATISTICHE</div>
                <p>Record: ${gameStats.highScore}</p>
                <p>Livello Max: ${gameStats.maxLevel}</p>
                <button class="modal-btn" onclick="closeModal()">CHIUDI</button>
            `;
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal-overlay').classList.add('visible');
        }

        function resizeGame() {
            const container = document.getElementById('scaler-container');
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            let baseWidth = winW >= 850 ? 850 : 540;
            let baseHeight = winW >= 850 ? 600 : 850;
            let scale = Math.min(winW / baseWidth, winH / baseHeight) * 0.95;
            container.style.transform = `scale(${Math.min(scale, 1.2)})`;
        }
        window.addEventListener('resize', resizeGame);
        window.addEventListener('load', () => { setTimeout(resizeGame, 50); loadStats(); });

        const rows = 10, cols = 10, cellSize = 50, TNT_VALUE = 9, TIME_PER_LEVEL = 90;
        let blocks = [], score = 0, bonusLives = 10, level = 1, isAnimating = false, nextBlockId = 0;
        let currentMission = { color: 1, targetSize: 0, completed: false }, timeRemaining = TIME_PER_LEVEL, timerInterval = null;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let isMusicPlaying = false, ambientInterval = null;

        function startGame() {
            document.getElementById('start-menu').style.display = 'none';
            document.getElementById('main-container').style.display = 'flex';
            if (audioCtx.state === 'suspended') audioCtx.resume();
            level = 1; score = 0; bonusLives = 10;
            setTimeout(() => { resizeGame(); initGame(); }, 50);
        }

        function initGame() {
            const gameArea = document.getElementById('game-area');
            gameArea.innerHTML = ''; blocks = [];
            let numColors = Math.min(level + 1, 5);
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const el = document.createElement('div'); el.classList.add('cube');
                    const block = { id: nextBlockId++, r, c, color: Math.floor(Math.random() * numColors) + 1, element: el };
                    gameArea.appendChild(el); blocks.push(block);
                    updateBlockVisual(block);
                }
            }
            blocks[Math.floor(Math.random()*blocks.length)].color = TNT_VALUE;
            blocks.forEach(updateBlockVisual);
            currentMission = { color: Math.floor(Math.random() * numColors) + 1, targetSize: Math.floor(Math.random() * 5) + 5, completed: false };
            updateMissionUI(); showLevelPopup();
            timeRemaining = TIME_PER_LEVEL; startTimer(); updateUI();
        }

        function updateBlockVisual(block) {
            block.element.className = 'cube ' + (block.color === TNT_VALUE ? 'tnt' : 'color-' + block.color);
            block.element.style.top = (block.r * cellSize + 2) + 'px';
            block.element.style.left = (block.c * cellSize + 2) + 'px';
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeRemaining--;
                document.getElementById('timer-display').textContent = timeRemaining;
                if (timeRemaining <= 0) { clearInterval(timerInterval); goToMenu(); }
            }, 1000);
        }

        function getBlockFromEvent(e) {
            const rect = document.getElementById('game-area').getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
            const c = Math.floor(x / (rect.width / cols)), r = Math.floor(y / (rect.height / rows));
            return blocks.find(b => b.r === r && b.c === c);
        }

        document.getElementById('game-area').onclick = (e) => {
            const b = getBlockFromEvent(e);
            if (b && !isAnimating) executeMove(b);
        };

        function executeMove(block) {
            let targets = (block.color === TNT_VALUE) ? getTNTTargets(block.r, block.c).concat([block]) : getMatches(block.r, block.c, block.color);
            if (targets.length > 1 || block.color === TNT_VALUE) {
                if (block.color !== TNT_VALUE && block.color === currentMission.color && targets.length === currentMission.targetSize) {
                    currentMission.completed = true; updateMissionUI();
                }
                score += targets.length * 10;
                destroyBlocks(targets);
            }
        }

        function getMatches(r, c, color) {
            let start = blocks.find(b => b.r===r && b.c===c); if(!start) return [];
            let m = [], s = [start], v = new Set([start.id]);
            while(s.length) {
                let curr = s.pop(); m.push(curr);
                [{r:curr.r-1,c:curr.c},{r:curr.r+1,c:curr.c},{r:curr.r,c:curr.c-1},{r:curr.r,c:curr.c+1}].forEach(p => {
                    let n = blocks.find(b => b.r===p.r && b.c===p.c); if(n && !v.has(n.id) && n.color === color) { v.add(n.id); s.push(n); }
                });
            }
            return m;
        }

        function getTNTTargets(r, c) {
            return blocks.filter(b => Math.abs(b.r - r) <= 2 && Math.abs(b.c - c) <= 2 && b.id !== blocks.find(x => x.r===r && x.c===c).id);
        }

        function destroyBlocks(targets) {
            isAnimating = true;
            const ids = new Set(targets.map(b => b.id));
            targets.forEach(b => b.element.classList.add('imploding'));
            setTimeout(() => {
                targets.forEach(b => b.element.remove());
                blocks = blocks.filter(b => !ids.has(b.id));
                // Gravit√†
                for (let c = 0; c < cols; c++) {
                    let col = blocks.filter(b => b.c === c).sort((a,b) => b.r - a.r);
                    col.forEach((b, i) => b.r = (rows - 1) - i);
                }
                blocks.forEach(updateBlockVisual);
                updateUI();
                isAnimating = false;
                if (blocks.length === 0) { level++; initGame(); }
            }, 300);
        }

        function updateUI() {
            document.getElementById('score-display').textContent = score;
            document.getElementById('level-display').textContent = level;
        }
        function updateMissionUI() {
            document.getElementById('mission-icon').className = 'mission-icon color-' + currentMission.color;
            document.getElementById('mission-target').textContent = currentMission.completed ? 'OK' : currentMission.targetSize;
        }
        function showLevelPopup() {
            const p = document.getElementById('level-popup');
            document.getElementById('popup-icon').className = 'popup-icon color-' + currentMission.color;
            document.getElementById('popup-target').textContent = currentMission.targetSize;
            p.classList.add('active'); setTimeout(() => p.classList.remove('active'), 2000);
        }
        function closeModal() { document.getElementById('modal-overlay').classList.remove('visible'); }
        function goToMenu() { location.reload(); }
        function confirmRestart() { if(confirm("Ricominciare?")) initGame(); }
        function toggleMusic() { isMusicPlaying = !isMusicPlaying; alert(isMusicPlaying ? "Musica ON" : "Musica OFF"); }
    </script>
</body>
</html>
